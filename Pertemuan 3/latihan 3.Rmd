---
title: "latihan 3"
output: html_document
---


# PERSIAPAN DATA DAN PEMILIHAN LAG

```{r}

library(readxl)
library(dplyr)

df <- read_excel("~/NewDelhi_Air_quality.xlsx")
names(df) <- tolower(names(df))

stopifnot(all(c("aqi","pm25") %in% names(df)))

data <- df %>%
  select(aqi, pm25) %>%
  rename(Y = aqi, X = pm25) %>%
  filter(!is.na(Y) & !is.na(X)) %>%
  arrange(row_number())

n <- nrow(data)
n_train <- floor(0.8 * n)

# bagi data
train <- data[1:n_train, ]
test  <- data[(n_train + 1):n, ]

y_train <- as.numeric(unlist(train$Y))
x_train <- as.numeric(unlist(train$X))
test_y  <- as.numeric(unlist(test$Y))
test_x  <- as.numeric(unlist(test$X))
h <- length(test_y)
```

```{r}
train_df <- data.frame(Yt = train$Y, Xt = train$X)

# Finite Distributed Lag Model (pilih q)
fdlm_out <- finiteDLMauto(Yt ~ Xt, data=train_df,
                          q.min=1, q.max=6,
                          model.type="dlm",
                          error.type="AIC",
                          trace=FALSE)

# ARDL (pilih p,q)
ardl_opt <- ardlBoundOrders(data=train_df, ic="AIC", formula=Yt ~ Xt)

# Simpan hasil lag optimum
q_opt <- if(!is.null(fdlm_out$q)) fdlm_out$q else 3
p_opt <- if(!is.null(ardl_opt$p)) as.numeric(ardl_opt$p) else 1
q_opt_ardl <- if(!is.null(ardl_opt$q)) as.numeric(ardl_opt$q) else 1

list(DLM_q = q_opt, ARDL_p = p_opt, ARDL_q = q_opt_ardl)
```
Pada model DLM, lag optimum yang dipilih adalah 6, artinya pengaruh PM2.5 terhadap AQI masih bertahan hingga enam periode sebelumnya.
Sedangkan pada model ARDL, lag optimum adalah 15 baik untuk AQI maupun PM2.5. Hal ini menunjukkan adanya dinamika jangka panjang, di mana kondisi AQI saat ini dipengaruhi oleh riwayat AQI dan PM2.5 hingga lima belas periode ke belakang.

# ESTIMASI MODEL
```{r}
# Model DLM
model_dlm <- dlm(formula = Yt ~ Xt, data=train_df, q=q_opt)

# Model Koyck
model_koyck <- koyckDlm(y = train_df$Yt, x = train_df$Xt, intercept = TRUE)

# Model ARDL
model_ardl <- ardlDlm(y = train_df$Yt, x = train_df$Xt, p=p_opt, q=q_opt_ardl)

summary(model_dlm)
summary(model_koyck)
summary(model_ardl)
```
DLM menjelaskan hubungan jangka menengah (6 lag) antara PM2.5 dan AQI, dengan kecocokan model yang tinggi (R² ~95%).

Koyck menekankan hubungan dinamis sederhana: AQI sangat dipengaruhi oleh nilai sebelumnya (persistensi tinggi, φ = 0.87).

ARDL menunjukkan dinamika jangka panjang yang kompleks, melibatkan banyak lag baik AQI maupun PM2.5, dengan ukuran kecocokan model yang juga baik (AIC dan BIC relatif kecil).
# EVALUASI MODEL TERBAIK
```{r}

# fitted values dari masing-masing model
fit_dlm   <- fitted(model_dlm)
fit_koyck <- fitted(model_koyck)
fit_ardl  <- fitted(model_ardl)

# buat vektor actual yang panjangnya sama
act_dlm   <- y_train[seq_along(fit_dlm)]
act_koyck <- y_train[seq_along(fit_koyck)]
act_ardl  <- y_train[seq_along(fit_ardl)]

# hitung akurasi
results <- data.frame(
  Model = c("DLM", "Koyck", "ARDL"),
  MAPE  = c(mape(act_dlm,   fit_dlm),
            mape(act_koyck, fit_koyck),
            mape(act_ardl,  fit_ardl)),
  MAE   = c(mae(act_dlm,   fit_dlm),
            mae(act_koyck, fit_koyck),
            mae(act_ardl,  fit_ardl)),
  MSE   = c(mean((act_dlm   - fit_dlm)^2),
            mean((act_koyck - fit_koyck)^2),
            mean((act_ardl  - fit_ardl)^2))
)

results <- results %>% arrange(MAPE)
print(results)

cat("Model terbaik (berdasarkan data training) adalah", 
    results$Model[1], "dengan MAPE =", round(results$MAPE[1],4), "\n")
```
Pemilihan lag menunjukkan bahwa model DLM optimal dengan lag 6, sedangkan model ARDL membutuhkan lag yang lebih panjang (p=15, q=15). Pada tahap estimasi, DLM mampu menjelaskan sekitar 94–98% variasi AQI, sedangkan Koyck menunjukkan adanya pengaruh kuat dari AQI periode sebelumnya (φ ≈ 0.87) dan ARDL menangkap dinamika jangka panjang.

Evaluasi model menunjukkan bahwa Koyck memiliki akurasi terbaik (MAPE = 0.0075) dengan kesalahan prediksi yang jauh lebih kecil dibandingkan DLM maupun ARDL. Hal ini menegaskan bahwa model Koyck lebih sesuai untuk menjelaskan hubungan AQI dengan PM2.5 pada data ini.

# VISUALISASI MODEL TERBAIK
```{r}
best_model <- results$Model[1]

# ambil fitted & actual sesuai model terbaik
if(best_model == "DLM"){
  fit_best <- fit_dlm
  act_best <- act_dlm
} else if(best_model == "Koyck"){
  fit_best <- fit_koyck
  act_best <- act_koyck
} else {
  fit_best <- fit_ardl
  act_best <- act_ardl
}

df_plot <- data.frame(
  index = seq_along(act_best),
  Actual = act_best,
  Fitted = fit_best
)

ggplot(df_plot, aes(x = index)) +
  geom_line(aes(y = Actual), color = "blue", size = 0.8) +
  geom_line(aes(y = Fitted), color = "red", linetype = "dashed", size = 0.8) +
  labs(title = paste("Actual vs Fitted - Best model:", best_model),
       x = "Index", y = "AQI") +
  theme_minimal()
```
Grafik memperlihatkan garis biru (AQI aktual) dan garis merah putus‐putus (hasil prediksi model Koyck) yang hampir tumpang tindih. Pola naik–turunnya keduanya serupa, selisihnya kecil, sehingga model Koyck mampu memprediksi perubahan AQI dengan baik dan mengikuti tren data nyata secara konsisten.

